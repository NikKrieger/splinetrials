---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# splinetrials

<!-- badges: start -->
[![Codecov test coverage](https://codecov.io/gh/NikKrieger/splinetrials/graph/badge.svg)](https://app.codecov.io/gh/NikKrieger/splinetrials)
[![R-CMD-check](https://github.com/NikKrieger/splinetrials/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/NikKrieger/splinetrials/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of splinetrials is to analyze longitudinal clinical data applying natural cubic splines to a continuous time variable.

## Installation

Install this package from CRAN with:

``` r
install.packages("splinetrials")
```

You can also install the development version of splinetrials from [GitHub](https://github.com/NikKrieger/splinetrials) with:

``` r
# install.packages("pak")
pak::pak("NikKrieger/splinetrials")
```

## Setup

```{r}
library(survival)
library(mmrm)
library(splinetrials)
library(dplyr)
library(ggplot2)
```

# Overview

The NCS model is a longitudinal mixed model of repeated measures (MMRM) with random effects marginalized out, additive baseline covariates, and time parameterized using natural cubic splines.

# Demo

## Data

The package functions accept data sets with **one row per patient per scheduled visit** (including baseline). 

We'll adapt the `pbcseq` data set in the survival package: 

```{r}
pbcseq_mod <- 
  survival::pbcseq |> 
  mutate(
    years = day / 365.25,
    visit_index =
      bin_timepoints( # splinetrials helper function yielding an ordered factor
        observed = years,
        scheduled = c(0, 0.5, 1:round(max(years))),
        labels = c("Baseline", paste(c(0.5, 1:round(max(years))), "yr"))
      ),
    sch_visit_years = c(0, 0.5, 1:round(max(years)))[as.numeric(visit_index)],
    sch_visit_label = as.character(visit_index),
    trt = factor(trt, labels = c("control", "treatment"))
  ) |> 
  arrange(id, visit_index, abs(years - sch_visit_years)) |>
  distinct(id, visit_index, .keep_all = TRUE) |> 
  select(id, visit_index:sch_visit_label, trt, everything()) |> 
  as_tibble()

pbcseq_mod
```

Notice how the helper function `splinetrials::bin_timepoints()` creates the visit index, categorizing follow-up visits based on when they were scheduled (see `?survival::pbcseq`).

## Basic NCS analysis

Once we have these variables created, we are ready for a full NCS analysis using `ncs_analysis()`. This produces a table of summary statistics, including LS means and confidence intervals:

```{r cache=TRUE}
pbc_spline_analysis <-
  ncs_analysis(
    data = pbcseq_mod,
    response = alk.phos,
    subject = id,
    arm = trt,
    control_group = "control",
    time_observed_continuous = years,
    time_observed_index = visit_index,
    time_scheduled_continuous = sch_visit_years,
    time_scheduled_label = sch_visit_label,
    covariates = ~ age + sex + bili + albumin + ast + protime
  )
pbc_spline_analysis
```

Note that the above warnings are expected, as splinetrials and `mmrm::mmrm()` iterate through different covariance structures and optimizers until a converging model is achieved.

We can plot the resulting model against the data by feeding the resulting data set to `ncs_plot_means()`:

```{r plot_means_no_subgroup}
p1 <- ncs_plot_means(pbc_spline_analysis)
p1
```

### Methods

The parameterization has additive effects and pairwise interactions for study arm and time point (i.e., spline basis functions). The model is constrained so that all study arms have equal means at baseline: notice that the same line passes through both the control group's and the treatment group's modeled mean baseline estimates:

```{r}
p1 +
  geom_hline(
    aes(yintercept = response_est),
    data = filter(pbc_spline_analysis, time == "Baseline"),
    linetype = 3
  )
```

## NCS subgroup analysis

Run a NCS analysis with subgroups using `ncs_analysis_subgroup()`. The data set should include a categorical variable to indicate subgroup membership. In this case, the `sex` variable serves as the `subgroup`.

```{r cache=TRUE}
subgroup_analysis_results <-
  ncs_analysis_subgroup(
    data = pbcseq_mod,
    response = alk.phos,
    subject = id,
    arm = trt,
    control_group = "control",
    subgroup = sex,
    subgroup_comparator = "f",
    time_observed_continuous = years,
    time_observed_index = visit_index,
    time_scheduled_continuous = sch_visit_years,
    time_scheduled_label = sch_visit_label,
    covariates = ~ age + bili + albumin + ast + protime,
    cov_structs = "ar1h",
    return_models = TRUE
  )
```

This function returns a list of multiple analyses, which are better looked at one at a time:

### Between subgroups and within subgroups

The `between` and `within` tables contain the same data except for the treatment effect columns. Note also that they are sorted differently.

#### `between`

The `between` table calculates treatment effects between the subgroups within each study arm:

```{r}
subgroup_analysis_results$between
```

#### `within`

The `within` table calculates treatment effects between each study arm within each subgroup:

```{r}
subgroup_analysis_results$within
```

#### Plotting the means

We can supply either of the above result entries (i.e., `between` or `within`) to `ncs_plot_means_subgroup()`. This function creates a grid of plots that again depict the actual and modeled mean responses at each timepoint. Each column of plots contains a study arm and each row of plots contains a subgroup.

We again include horizontal lines to demonstrate that the study arms all have the same modeled mean baseline estimate:

```{r}
ncs_plot_means_subgroup(subgroup_analysis_results$between) +
  geom_hline(
    aes(yintercept = response_est),
    data = filter(subgroup_analysis_results$between, time == "Baseline"),
    linetype = 3,
    lwd = 0.5
  )
```

### Type-III ANOVA

`type3` contains a Type-III ANOVA on the main analysis model's terms:

```{r}
subgroup_analysis_results$type3
```

### Subgroup interaction test

The optional `interaction` result contains an ANOVA comparing the original model fit to a reduced version:

```{r}
subgroup_analysis_results$interaction
```

### `return_models = TRUE`

Lastly, the user can optionally obtain the original analysis model object as well as those used for the subgroup interaction test, which are returned as the `analysis_model`, `full`, and `reduced` entries. These are `mmrm` objects created using `mmrm::mmrm()`. Here is `analysis_model`, for example:

```{r}
subgroup_analysis_results$analysis_model
```


# Appendix: details of the analysis results tables

## Basic NCS analysis

The basic NCS analysis results table `pbc_spline_analysis` has one row per study arm per timepoint of interest and the following columns:

* `arm`: study arm, i.e. treatment group
* `time`: discrete visit time labels from the `time_scheduled_label` column in the data.
* `n`: number of non-missing observations.
* `est`: observed mean response in the data.
* `sd`: observed standard deviation of the response in the data.
* `se`: observed standard error of the response in the data (just `se / sqrt(n)`).
* `lower`: lower bound of an observed 95% confidence interval in the data.
* `upper`: upper bound of an observed 95% confidence interval in the data.
* `response_est`: LS mean of the response.
* `response_se`: standard error of the LS mean of the response.
* `response_df`: degrees of freedom of the LS mean of the response.
* `response_lower`: lower 95% confidence bound of the LS mean of the response.
* `response_upper`: upper 95% confidence bound of the LS mean of the response.
* `change_est`, `change_lower`, `change_upper`, `change_se`, `change_df`: like the analogous `response_*` columns, but for LS mean change from baseline.
* `change_test_statistic`: test statistic of a two-sided test that the LS mean change from baseline is not equal to 0, at a significance level of 5%.
* `change_p_value`: same as `change_test_statistic`, but the p-value instead of the test statistic.
* `diff_est`, `diff_se`, `diff_df`, `diff_lower`, `diff_upper`, `diff_test_statistic`, `diff_p_value`: same as the analogous `change_*` columns, but for treatment differences.
* `percent_slowing_est` LS mean of percent slowing (on the percentage scale).
* `percent_slowing_lower`, `percent_slowing_upper`: a conservative approximation to a confidence interval on percent slowing. Assumes uncorrelated changes from baseline.
* `correlation`: correlation structure of the whole model.
* `optimizer`: optimization algorithm for the whole model.

## Subgroup analysis

### `between` and `within` tables

The between-subgroup and within-subgroup tables have one row per study arm per timepoint per subgroup and the following columns:

* `arm`: study arm, i.e. treatment group
* `time`: discrete visit time labels from the `time_scheduled_label` column in the data.
* `subgroup`: subgroup level
* `n`: number of non-missing observations.
* `est`: observed mean response in the data.
* `sd`: observed standard deviation of the response in the data.
* `se`: observed standard error of the response in the data (just `se / sqrt(n)`).
* `lower`: lower bound of an observed 95% confidence interval in the data.
* `upper`: upper bound of an observed 95% confidence interval in the data.
* `response_est`: LS mean of the response.
* `response_se`: standard error of the LS mean of the response.
* `response_df`: degrees of freedom of the LS mean of the response.
* `response_lower`: lower 95% confidence bound of the LS mean of the response.
* `response_upper`: upper 95% confidence bound of the LS mean of the response.
* `change_est`, `change_lower`, `change_upper`, `change_se`, `change_df`: like the analogous `response_*` columns, but for LS mean change from baseline.
* `change_test_statistic`: test statistic of a two-sided test that the LS mean change from baseline is not equal to 0, at a significance level of 5%.
* `change_p_value`: same as `change_test_statistic`, but the p-value instead of the test statistic.
* `diff_arm_est`, `diff_arm_se`, `diff_arm_df`, `diff_arm_lower`, `diff_arm_upper`, `diff_arm_test_statistic`, `diff_arm_p_value`: same as the analogous `change_*` columns, but for treatment differences.
* `diff_subgroup_est`, `diff_subgroup_se`, `diff_subgroup_df`, `diff_subgroup_lower`, `diff_subgroup_upper`, `diff_subgroup_test_statistic`, `diff_subgroup_p_value`: same as the analogous `*_arm_*` columns, but for the subgroup differences.
* `percent_slowing_est` LS mean of percent slowing (on the percentage scale).
* `percent_slowing_lower`, `percent_slowing_upper`: a conservative approximation to a confidence interval on percent slowing. Assumes uncorrelated changes from baseline.
* `correlation`: correlation structure of the analysis subgroup model.
* `optimizer`: optimizer of the analysis subgroup model.

### `type3` column descriptions

The Type-III ANOVA table has one row per effect in the main analysis model and the following columns:

* `effect`: the model effect in the main analysis model
* `chisquare_test_statistic`: Chi-squared test statistic for the model term's significance
* `df`: degrees of freedom
* `p_value`: p-value for the test of the model term's significance
* `correlation`: correlation structure of the analysis subgroup model.
* `optimizer`: optimizer of the analysis subgroup model.

### `interaction` column descriptions

The subgroup interaction test table will have two rows: the first will represent the reduced model and the second will depict the full model. Likelihood ratio test results will only be in the latter row. The table will contain the following columns:

* `model`: the model, either full or reduced.
* `df`: degrees of freedom
* `aic`: Akaike Information Criterion
* `bic`: Bayesian Information Criterion
* `loglik`: log likelihood
* `test_statistic`: test statistic of the likelihood ratio test.
* `p_value`: p-value of the likelihood ratio test.
* `correlation`: correlation structures of the full and reduced models of the interaction test.
* `optimizer`: optimizers of the full and reduced models of the interaction test.
